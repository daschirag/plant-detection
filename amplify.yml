version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Checking environment variables..."
        - |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "ERROR: OPENAI_API_KEY environment variable is not set!"
            echo "Please set OPENAI_API_KEY in Amplify Console > App Settings > Environment Variables"
            exit 1
          else
            echo "SUCCESS: OPENAI_API_KEY is set (length: ${#OPENAI_API_KEY} characters)"
            echo "SUCCESS: Key prefix: ${OPENAI_API_KEY:0:6}..."
            if [[ ! "$OPENAI_API_KEY" =~ ^sk- ]]; then
              echo "WARNING: API key should start with 'sk-'"
            fi
          fi
        - npm ci --legacy-peer-deps || npm install --legacy-peer-deps
    build:
      commands:
        - npm run build
        - echo "Build completed successfully"
        - echo "After deployment, test API endpoint at /api/test-openai-connection"
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
customHeaders:
  - pattern: '**/*'
    headers:
      - key: 'Cache-Control'
        value: 'public, max-age=0, must-revalidate'


